<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Connections - LegacyKeeper</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .connections-container {
      display: grid;
      gap: 2rem;
      margin: 2rem 0;
    }
    .connection-section {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 1.5rem;
      border: 2px solid var(--border-color);
    }
    .connection-section h2 {
      color: var(--accent-primary);
      margin: 0 0 1.5rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .connection-count {
      font-size: 0.9rem;
      background: var(--accent-primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
    }
    .connections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .connection-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 1.25rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }
    .connection-card:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
    }
    .connection-header {
      display: flex;
      align-items: start;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .connection-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }
    .connection-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .connection-info {
      flex: 1;
      min-width: 0;
    }
    .connection-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 0.25rem 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .connection-type {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .connection-details {
      margin: 1rem 0;
    }
    .connection-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }
    .connection-detail-row:last-child {
      border-bottom: none;
    }
    .connection-detail-label {
      color: var(--text-secondary);
    }
    .connection-detail-value {
      color: var(--text-primary);
      font-weight: 500;
    }
    .connection-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover {
      color: var(--text-primary);
    }
    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .permission-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
    }
    .permission-badge.granted {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success-color);
    }
    .permission-badge.denied {
      background: rgba(244, 67, 54, 0.2);
      color: var(--error-color);
    }
  </style>
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container">
    <%- include('../partials/alerts') %>

    <div class="page-header">
      <h1 class="page-title">My Connections</h1>
      <a href="/connections/add" class="btn btn-primary">Add Connection</a>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('all')">All Connections (<%= userConnections.length + contactConnections.length + groupConnections.length %>)</button>
      <button class="tab" onclick="showTab('users')">Users (<%= userConnections.length %>)</button>
      <button class="tab" onclick="showTab('contacts')">Contacts (<%= contactConnections.length %>)</button>
      <button class="tab" onclick="showTab('groups')">Contact Groups (<%= groupConnections.length %>)</button>
    </div>

    <!-- All Connections Tab -->
    <div id="all-tab" class="tab-content active">
      <% if (userConnections.length === 0 && contactConnections.length === 0 && groupConnections.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon">🔗</div>
          <h3>No Connections Yet</h3>
          <p>Start connecting with other users, contacts, and contact groups to build your network.</p>
          <a href="/connections/add" class="btn btn-primary" style="margin-top: 1rem;">Add Your First Connection</a>
        </div>
      <% } else { %>
        <% if (userConnections.length > 0) { %>
          <div class="connection-section">
            <h2>
              Connected Users
              <span class="connection-count"><%= userConnections.length %></span>
            </h2>
            <div class="connections-grid">
              <% userConnections.forEach(conn => { %>
                <div class="connection-card">
                  <div class="connection-header">
                    <div class="connection-avatar">
                      <% if (conn.data.ProfilePicture) { %>
                        <img src="<%= conn.data.ProfilePicture %>" alt="<%= conn.data.FirstName %>">
                      <% } else { %>
                        <%= conn.data.FirstName.charAt(0) %><%= conn.data.LastName ? conn.data.LastName.charAt(0) : '' %>
                      <% } %>
                    </div>
                    <div class="connection-info">
                      <h3 class="connection-name"><%= conn.data.FirstName %> <%= conn.data.LastName %></h3>
                      <div class="connection-type">User <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                    </div>
                  </div>
                  <div class="connection-details">
                    <div class="connection-detail-row">
                      <span class="connection-detail-label">Email:</span>
                      <span class="connection-detail-value"><%= conn.data.Email %></span>
                    </div>
                    <% if (conn.connection.CanViewDocuments || conn.connection.CanViewAssets || conn.connection.NotifyOnUpdates) { %>
                      <div class="connection-detail-row">
                        <span class="connection-detail-label">Permissions:</span>
                        <span class="connection-detail-value">
                          <% if (conn.connection.CanViewDocuments) { %>
                            <span class="permission-badge granted">Docs</span>
                          <% } %>
                          <% if (conn.connection.CanViewAssets) { %>
                            <span class="permission-badge granted">Assets</span>
                          <% } %>
                          <% if (conn.connection.NotifyOnUpdates) { %>
                            <span class="permission-badge granted">Notify</span>
                          <% } %>
                        </span>
                      </div>
                    <% } %>
                  </div>
                  <div class="connection-actions">
                    <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                    <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                    <a href="/chat?with=<%= conn.data.UniqueId %>" class="btn btn-primary btn-small">Message</a>
                    <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                      <button type="submit" class="btn btn-danger btn-small">Remove</button>
                    </form>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>

        <% if (contactConnections.length > 0) { %>
          <div class="connection-section">
            <h2>
              Connected Contacts
              <span class="connection-count"><%= contactConnections.length %></span>
            </h2>
            <div class="connections-grid">
              <% contactConnections.forEach(conn => { %>
                <div class="connection-card">
                  <div class="connection-header">
                    <div class="connection-avatar">
                      <%= conn.data.FirstName.charAt(0) %><%= conn.data.LastName ? conn.data.LastName.charAt(0) : '' %>
                    </div>
                    <div class="connection-info">
                      <h3 class="connection-name"><%= conn.data.FirstName %> <%= conn.data.LastName %></h3>
                      <div class="connection-type">Contact <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                    </div>
                  </div>
                  <div class="connection-details">
                    <% if (conn.data.Email) { %>
                      <div class="connection-detail-row">
                        <span class="connection-detail-label">Email:</span>
                        <span class="connection-detail-value"><%= conn.data.Email %></span>
                      </div>
                    <% } %>
                    <% if (conn.data.PhoneNumber) { %>
                      <div class="connection-detail-row">
                        <span class="connection-detail-label">Phone:</span>
                        <span class="connection-detail-value"><%= conn.data.PhoneNumber %></span>
                      </div>
                    <% } %>
                  </div>
                  <div class="connection-actions">
                    <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                    <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                    <a href="/contacts/<%= conn.data.UniqueId %>/edit" class="btn btn-primary btn-small">Edit Contact</a>
                    <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                      <button type="submit" class="btn btn-danger btn-small">Remove</button>
                    </form>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>

        <% if (groupConnections.length > 0) { %>
          <div class="connection-section">
            <h2>
              Connected Contact Groups
              <span class="connection-count"><%= groupConnections.length %></span>
            </h2>
            <div class="connections-grid">
              <% groupConnections.forEach(conn => { %>
                <div class="connection-card">
                  <div class="connection-header">
                    <div class="connection-avatar">
                      <%= conn.data.GroupName.charAt(0) %>
                    </div>
                    <div class="connection-info">
                      <h3 class="connection-name"><%= conn.data.GroupName %></h3>
                      <div class="connection-type">Contact Group <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                    </div>
                  </div>
                  <div class="connection-details">
                    <div class="connection-detail-row">
                      <span class="connection-detail-label">Members:</span>
                      <span class="connection-detail-value"><%= conn.data.Members ? conn.data.Members.length : 0 %></span>
                    </div>
                    <% if (conn.data.Description) { %>
                      <div class="connection-detail-row">
                        <span class="connection-detail-label">Description:</span>
                        <span class="connection-detail-value" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"><%= conn.data.Description %></span>
                      </div>
                    <% } %>
                  </div>
                  <div class="connection-actions">
                    <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                    <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                    <a href="/contact-groups/<%= conn.data.UniqueId %>" class="btn btn-primary btn-small">View Group</a>
                    <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                      <button type="submit" class="btn btn-danger btn-small">Remove</button>
                    </form>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% } %>
      <% } %>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <% if (userConnections.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon">👥</div>
          <h3>No User Connections</h3>
          <p>Connect with other LegacyKeeper users to share and collaborate.</p>
          <a href="/connections/add" class="btn btn-primary" style="margin-top: 1rem;">Add User Connection</a>
        </div>
      <% } else { %>
        <div class="connections-grid">
          <% userConnections.forEach(conn => { %>
            <div class="connection-card">
              <div class="connection-header">
                <div class="connection-avatar">
                  <% if (conn.data.ProfilePicture) { %>
                    <img src="<%= conn.data.ProfilePicture %>" alt="<%= conn.data.FirstName %>">
                  <% } else { %>
                    <%= conn.data.FirstName.charAt(0) %><%= conn.data.LastName ? conn.data.LastName.charAt(0) : '' %>
                  <% } %>
                </div>
                <div class="connection-info">
                  <h3 class="connection-name"><%= conn.data.FirstName %> <%= conn.data.LastName %></h3>
                  <div class="connection-type">User <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                </div>
              </div>
              <div class="connection-details">
                <div class="connection-detail-row">
                  <span class="connection-detail-label">Email:</span>
                  <span class="connection-detail-value"><%= conn.data.Email %></span>
                </div>
              </div>
              <div class="connection-actions">
                <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                <a href="/chat?with=<%= conn.data.UniqueId %>" class="btn btn-primary btn-small">Message</a>
                <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                  <button type="submit" class="btn btn-danger btn-small">Remove</button>
                </form>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>

    <!-- Contacts Tab -->
    <div id="contacts-tab" class="tab-content">
      <% if (contactConnections.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon">📇</div>
          <h3>No Contact Connections</h3>
          <p>Link your contacts to access them quickly and manage permissions.</p>
          <a href="/connections/add" class="btn btn-primary" style="margin-top: 1rem;">Add Contact Connection</a>
        </div>
      <% } else { %>
        <div class="connections-grid">
          <% contactConnections.forEach(conn => { %>
            <div class="connection-card">
              <div class="connection-header">
                <div class="connection-avatar">
                  <%= conn.data.FirstName.charAt(0) %><%= conn.data.LastName ? conn.data.LastName.charAt(0) : '' %>
                </div>
                <div class="connection-info">
                  <h3 class="connection-name"><%= conn.data.FirstName %> <%= conn.data.LastName %></h3>
                  <div class="connection-type">Contact <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                </div>
              </div>
              <div class="connection-details">
                <% if (conn.data.Email) { %>
                  <div class="connection-detail-row">
                    <span class="connection-detail-label">Email:</span>
                    <span class="connection-detail-value"><%= conn.data.Email %></span>
                  </div>
                <% } %>
                <% if (conn.data.PhoneNumber) { %>
                  <div class="connection-detail-row">
                    <span class="connection-detail-label">Phone:</span>
                    <span class="connection-detail-value"><%= conn.data.PhoneNumber %></span>
                  </div>
                <% } %>
              </div>
              <div class="connection-actions">
                <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                <a href="/contacts/<%= conn.data.UniqueId %>/edit" class="btn btn-primary btn-small">Edit Contact</a>
                <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                  <button type="submit" class="btn btn-danger btn-small">Remove</button>
                </form>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>

    <!-- Groups Tab -->
    <div id="groups-tab" class="tab-content">
      <% if (groupConnections.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon">👨‍👩‍👧‍👦</div>
          <h3>No Group Connections</h3>
          <p>Connect contact groups to manage multiple contacts together.</p>
          <a href="/connections/add" class="btn btn-primary" style="margin-top: 1rem;">Add Group Connection</a>
        </div>
      <% } else { %>
        <div class="connections-grid">
          <% groupConnections.forEach(conn => { %>
            <div class="connection-card">
              <div class="connection-header">
                <div class="connection-avatar">
                  <%= conn.data.GroupName.charAt(0) %>
                </div>
                <div class="connection-info">
                  <h3 class="connection-name"><%= conn.data.GroupName %></h3>
                  <div class="connection-type">Contact Group <%= conn.connection.RelationshipType ? '• ' + conn.connection.RelationshipType : '' %></div>
                </div>
              </div>
              <div class="connection-details">
                <div class="connection-detail-row">
                  <span class="connection-detail-label">Members:</span>
                  <span class="connection-detail-value"><%= conn.data.Members ? conn.data.Members.length : 0 %></span>
                </div>
              </div>
              <div class="connection-actions">
                <a href="/connections/<%= conn.connection.UniqueId %>" class="btn btn-secondary btn-small">View</a>
                <a href="/connections/<%= conn.connection.UniqueId %>/edit" class="btn btn-secondary btn-small">Edit</a>
                <a href="/contact-groups/<%= conn.data.UniqueId %>" class="btn btn-primary btn-small">View Group</a>
                <form action="/connections/<%= conn.connection.UniqueId %>?_method=DELETE" method="POST" style="display: inline;" onsubmit="return confirm('Remove this connection?');">
                  <button type="submit" class="btn btn-danger btn-small">Remove</button>
                </form>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }
  </script>
</body>
</html>
